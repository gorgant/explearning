<form
    class="purchase-data-form"
    [formGroup]="purchaseDataForm"
    (ngSubmit)="onSubmit()"
    fxLayout="column"
    fxLayoutAlign="center center"
    fxLayoutGap="16px">
  <div class="billing-details-group" formGroupName="billingDetailsGroup" fxLayout="column" fxLayoutAlign="center center" fxLayoutGap="16px" fxLayoutAlign.gt-sm="center start">
    <mat-form-field class="country">
      <mat-label>Select Country</mat-label>
      <mat-select formControlName="countryCode" (selectionChange)="setCountry($event.value)">
        <mat-option *ngFor="let country of (geographicData$ | async)?.countryList" [value]="country.code">{{ country.name }}</mat-option>
      </mat-select>
      <mat-error *ngFor="let validation of billingValidationMessages.countryCode">
        <mat-error *ngIf="countryCode.hasError(validation.type) && countryCode.invalid && (countryCode.dirty || countryCode.touched)">{{ validation.message }}</mat-error>
      </mat-error>
    </mat-form-field>
    <mat-form-field class="first-name">
      <input matInput formControlName="firstName" type="text" placeholder="First Name">
      <mat-error *ngFor="let validation of billingValidationMessages.firstName">
        <mat-error *ngIf="firstName.hasError(validation.type) && firstName.invalid && (firstName.dirty || firstName.touched)">{{ validation.message }}</mat-error>
      </mat-error>
    </mat-form-field>
    <mat-form-field class="last-name">
      <input matInput formControlName="lastName" type="text" placeholder="Last Name">
      <mat-error *ngFor="let validation of billingValidationMessages.lastName">
        <mat-error *ngIf="lastName.hasError(validation.type) && lastName.invalid && (lastName.dirty || lastName.touched)">{{ validation.message }}</mat-error>
      </mat-error>
    </mat-form-field>
    <mat-form-field class="email">
      <input matInput formControlName="email" type="email" placeholder="Email">
      <mat-error *ngFor="let validation of billingValidationMessages.email">
        <mat-error *ngIf="email.hasError(validation.type) && email.invalid && (email.dirty || email.touched)">{{ validation.message }}</mat-error>
      </mat-error>
    </mat-form-field>
    <mat-form-field class="phone">
      <input matInput formControlName="phone" type="phone" placeholder="Phone">
      <mat-error *ngFor="let validation of billingValidationMessages.phone">
        <mat-error *ngIf="phone.hasError(validation.type) && phone.invalid && (phone.dirty || phone.touched)">{{ validation.message }}</mat-error>
      </mat-error>
    </mat-form-field>
    <mat-form-field class="billing-one">
      <input matInput formControlName="billingOne" type="text" placeholder="Billing Address 1">
      <mat-error *ngFor="let validation of billingValidationMessages.billingOne">
        <mat-error *ngIf="billingOne.hasError(validation.type) && billingOne.invalid && (billingOne.dirty || billingOne.touched)">{{ validation.message }}</mat-error>
      </mat-error>
    </mat-form-field>
    <mat-form-field class="billing-two">
      <input matInput formControlName="billingTwo" type="text" placeholder="Billing Address 2">
      <mat-error *ngFor="let validation of billingValidationMessages.billingTwo">
        <mat-error *ngIf="billingTwo.hasError(validation.type) && billingTwo.invalid && (billingTwo.dirty || billingTwo.touched)">{{ validation.message }}</mat-error>
      </mat-error>
    </mat-form-field>
    <mat-form-field class="city">
      <input matInput formControlName="city" type="text" placeholder="City">
      <mat-error *ngFor="let validation of billingValidationMessages.city">
        <mat-error *ngIf="city.hasError(validation.type) && city.invalid && (city.dirty || city.touched)">{{ validation.message }}</mat-error>
      </mat-error>
    </mat-form-field>
    <mat-form-field *ngIf="countryCode.value !== 'US'" class="state">
      <input matInput formControlName="state" type="text" placeholder="State/Province">
      <mat-error *ngFor="let validation of billingValidationMessages.state">
        <mat-error *ngIf="state.hasError(validation.type) && state.invalid && (state.dirty || state.touched)">{{ validation.message }}</mat-error>
      </mat-error>
    </mat-form-field>
    <mat-form-field *ngIf="countryCode.value === 'US'" class="state">
      <mat-label>Select State</mat-label>
      <mat-select formControlName="usStateCode" (selectionChange)="setUsState($event.value)">
        <mat-option *ngFor="let state of (geographicData$ | async)?.usStateList" [value]="state.abbr">{{ state.name }}</mat-option>
      </mat-select>
      <mat-error *ngFor="let validation of billingValidationMessages.usStateCode">
        <mat-error *ngIf="usStateCode.hasError(validation.type) && usStateCode.invalid && (usStateCode.dirty || usStateCode.touched)">{{ validation.message }}</mat-error>
      </mat-error>
    </mat-form-field>
    <mat-form-field class="postal-code">
      <input matInput formControlName="postalCode" type="text" placeholder="Postal Code">
      <mat-error *ngFor="let validation of billingValidationMessages.postalCode">
        <mat-error *ngIf="postalCode.hasError(validation.type) && postalCode.invalid && (postalCode.dirty || postalCode.touched)">{{ validation.message }}</mat-error>
      </mat-error>
    </mat-form-field>
  </div>

  <div *ngIf="!(paymentProcessing$ | async)" class="credit-card-details-group" [ngClass]="{'credit-card-error': (paymentResponse$ | async) === paymentResponseTypes.REJECTED}" formGroupName="creditCardDetailsGroup" fxLayout="column" fxLayoutAlign="center center" fxLayoutAlign.gt-sm="center start">
    <div class="card-details-title">Enter Your Billing Information - SECURE</div>
    <mat-form-field class="card-Name">
      <input matInput formControlName="cardName" type="text" placeholder="Card Name" [value]="cardName.value ? cardName.value : firstName.value + ' ' + lastName.value">
    </mat-form-field>
    <mat-form-field class="card-number">
      <input matInput formControlName="cardNumber" type="phone" placeholder="Card Number">
      <mat-error *ngFor="let validation of creditCardValidationMessages.cardNumber">
        <mat-error *ngIf="cardNumber.hasError(validation.type) && cardNumber.invalid && (cardNumber.dirty || cardNumber.touched)">{{ validation.message }}</mat-error>
      </mat-error>
    </mat-form-field>
    <div class="card-expiration-container" fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="16px">
      <mat-form-field class="card-month">
        <input matInput formControlName="cardMonth" type="phone" placeholder="MM">
      </mat-form-field>
      <div class="month-year-spacer">/</div>
      <mat-form-field class="card-year">
        <input matInput formControlName="cardYear" type="phone" placeholder="YY">
      </mat-form-field>
      <mat-form-field class="card-cvc">
        <input matInput formControlName="cardCvc" type="phone" placeholder="CVC">
      </mat-form-field>
    </div>
    <div fxFlexAlign="center" class="buy-button-container" fxLayout="column" fxLayoutAlign="center center">
      <button *ngIf="purchaseDataForm.invalid || !invoiceInitialized" class="buy-button" mat-raised-button [disabled]="purchaseDataForm.invalid || !invoiceInitialized" color="primary" type="submit">Complete Form to Proceed</button>
      <button *ngIf="purchaseDataForm.valid && invoiceInitialized" class="buy-button" mat-raised-button color="primary" type="submit">Get {{ product.name }}</button>
      <div class="processing-hint">It can take up to 30 seconds to process your order, so please be patient.</div>
    </div>
  </div>

  <div *ngIf="(paymentProcessing$ | async)" class="payment-processing-container" fxLayout="column" fxLayoutAlign="center center">
    <div class="payment-processing-text">Payment Processing -- Please Be Patient</div>
    <mat-progress-spinner color="accent" mode="indeterminate"></mat-progress-spinner>
  </div>
  
  <div *ngIf="(paymentResponse$ | async) === paymentResponseTypes.REJECTED">
    <div class="payment-failed">Payment failed. No charge was applied to your card. Please confirm your billing information and try again.</div>
  </div>

</form>
